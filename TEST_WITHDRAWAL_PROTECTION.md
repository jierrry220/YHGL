# 提现三重保护机制测试指南

## 服务器状态
✅ 服务器已启动：`http://localhost:3000`
✅ 管理员面板：`http://localhost:3000/api/admin`
✅ 密码：`Iagez220!`

## 测试准备

### 1. 准备测试用户
需要一个有足够余额的测试用户（至少 10000 DP）

### 2. 测试工具
- 游戏前端：`C:\Users\CDD\Desktop\DBP-Frontend-beta\game-platform.html`
- 管理员面板：`C:\Users\CDD\Desktop\DBP-Owner-Panel\admin-panel.html`

## 测试场景

### 场景1：方案1测试 - 防止重复申请 ⭐⭐⭐

**目标**：验证用户不能提交多个待审核的提现

**步骤**：
1. 登录游戏前端，确保余额 ≥ 10000 DP
2. 申请提现 5000 DP（触发人工审核）
3. 等待提示"需要人工审核"
4. **立即再次**申请提现 5000 DP

**预期结果**：
- ❌ 第二次申请被拒绝
- 错误消息："您有一笔提现申请正在审核中，请等待审核完成后再提交新申请"

**验证方法**：
```
在管理员面板 → 提现审核
应该只看到1个待审核的提现
```

---

### 场景2：方案3测试 - 冻结余额防止消费 ⭐⭐⭐

**目标**：验证提现申请后余额被冻结，无法在审核期间消费

**步骤**：
1. 用户余额 10000 DP
2. 申请提现 5000 DP（触发人工审核）
3. 提现进入审核，余额应该被冻结
4. **尝试参与游戏**，投注 6000 DP

**预期结果**：
- ✅ 总余额：10000 DP
- ✅ 冻结余额：5000 DP
- ✅ 可用余额：5000 DP
- ❌ 投注 6000 DP 失败
- 错误消息："可用余额不足（当前有 5000.00 DP 被冻结中，等待提现审核）"

**验证方法**：
```javascript
// 在管理员面板控制台查看用户余额
{
  "balance": 10000,
  "frozenBalance": 5000,
  "availableBalance": 5000  // 总余额 - 冻结余额
}
```

---

### 场景3：审核通过 - 正常流程 ⭐⭐

**目标**：验证审核通过时正确扣除冻结余额和总余额

**步骤**：
1. 用户余额 10000 DP
2. 申请提现 5000 DP（触发审核）
3. 管理员登录面板，进入"提现审核"
4. 批准该提现申请

**预期结果**：
- ✅ 链上转账 5000 DP 成功
- ✅ 用户总余额：10000 → 5000 DP
- ✅ 冻结余额：5000 → 0 DP
- ✅ 可用余额：5000 DP
- ✅ 审核状态：approved

**验证方法**：
```
1. 检查用户余额变化
2. 检查区块链交易记录
3. 检查提现审核状态
```

---

### 场景4：审核拒绝 - 解冻余额 ⭐⭐

**目标**：验证审核拒绝时正确解冻余额

**步骤**：
1. 用户余额 10000 DP
2. 申请提现 5000 DP（触发审核）
3. 管理员拒绝该提现申请，填写原因

**预期结果**：
- ✅ 用户总余额：10000 DP（不变）
- ✅ 冻结余额：5000 → 0 DP
- ✅ 可用余额：10000 DP（恢复）
- ✅ 审核状态：rejected
- ✅ 用户可以再次申请提现

**验证方法**：
```
1. 检查用户余额是否完全恢复
2. 尝试投注或再次提现应该成功
```

---

### 场景5：方案2测试 - 余额不足自动拒绝 ⭐⭐⭐

**目标**：验证批准时如果余额不足，自动拒绝并解冻

**重要**：这个场景需要模拟系统故障，正常情况下不会发生

**模拟步骤**（需要直接修改数据）：
1. 用户余额 5000 DP
2. 申请提现 5000 DP（触发审核，冻结5000）
3. **手动修改数据库**，将用户余额改为 2000 DP
4. 管理员批准该提现

**预期结果**：
- ❌ 转账被阻止
- ✅ 自动拒绝审核
- ✅ 解冻 5000 DP
- ✅ 审核状态：rejected
- ✅ 拒绝原因："系统自动拒绝：余额不足"

**验证方法**：
```
1. 检查转账没有执行
2. 检查审核状态变为rejected
3. 检查冻结余额被释放
```

---

### 场景6：极端测试 - 多重保护验证 ⭐⭐⭐⭐

**目标**：测试所有保护机制同时工作

**步骤**：
1. 用户余额 10000 DP
2. 申请提现 5000 DP（审核中，冻结5000）
3. 尝试再次提现 5000 DP → 方案1拦截 ✅
4. 尝试投注 6000 DP → 方案3拦截 ✅
5. 投注 4000 DP → 成功（可用余额5000足够）
6. 当前余额：6000 DP，冻结5000 DP
7. 管理员批准提现
8. 方案2检查：6000 ≥ 5000 ✅
9. 转账成功，最终余额：1000 DP

**预期结果**：所有保护机制正常工作，最终状态正确

---

## 快速测试命令（PowerShell）

### 1. 检查服务器状态
```powershell
Invoke-RestMethod -Uri "http://localhost:3000/api/admin/dashboard?password=Iagez220!"
```

### 2. 查看待审核提现列表
```powershell
Invoke-RestMethod -Uri "http://localhost:3000/api/admin/withdraw-reviews?password=Iagez220!&status=pending"
```

### 3. 查看所有提现审核（包括已处理）
```powershell
Invoke-RestMethod -Uri "http://localhost:3000/api/admin/withdraw-reviews?password=Iagez220!&status=all"
```

### 4. 查看用户余额详情（替换ADDRESS）
```powershell
Invoke-RestMethod -Uri "http://localhost:3000/api/admin/users/ADDRESS?password=Iagez220!"
```

### 5. 批准提现（替换REVIEW_ID）
```powershell
$body = @{note='测试批准'} | ConvertTo-Json
Invoke-RestMethod -Uri "http://localhost:3000/api/admin/withdraw-reviews/REVIEW_ID/approve?password=Iagez220!" -Method Post -Body $body -ContentType "application/json"
```

### 6. 拒绝提现（替换REVIEW_ID）
```powershell
$body = @{note='测试拒绝'} | ConvertTo-Json
Invoke-RestMethod -Uri "http://localhost:3000/api/admin/withdraw-reviews/REVIEW_ID/reject?password=Iagez220!" -Method Post -Body $body -ContentType "application/json"
```

---

## 测试检查清单

### 功能验证
- [ ] 方案1：重复申请被拒绝
- [ ] 方案2：余额不足自动拒绝
- [ ] 方案3：余额冻结功能正常
- [ ] 审核通过：正确扣除余额
- [ ] 审核拒绝：正确解冻余额
- [ ] 可用余额计算正确

### 数据完整性
- [ ] `frozenBalances` 字段正确保存
- [ ] 交易记录包含 `frozen` 状态
- [ ] 审核记录状态正确更新
- [ ] 余额计算准确无误

### 边界情况
- [ ] 余额为0时无法提现
- [ ] 冻结余额大于总余额时的处理
- [ ] 同时多个用户提现不冲突
- [ ] 审核通过后可以再次申请

---

## 测试报告模板

### 测试环境
- 服务器：http://localhost:3000
- 测试时间：2025-12-02
- 测试人员：___________

### 测试结果

| 场景 | 状态 | 说明 |
|------|------|------|
| 场景1：防止重复申请 | ⬜ | |
| 场景2：冻结余额防消费 | ⬜ | |
| 场景3：审核通过流程 | ⬜ | |
| 场景4：审核拒绝解冻 | ⬜ | |
| 场景5：余额不足拦截 | ⬜ | |
| 场景6：极端多重测试 | ⬜ | |

### 发现的问题
1. 
2. 
3. 

### 建议改进
1. 
2. 
3. 

---

## 注意事项

1. **测试顺序**：建议按场景1→2→3→4的顺序测试
2. **数据备份**：测试前备份 `data/` 目录
3. **链上交易**：测试需要真实的链上转账，确保钱包有足够的 Gas
4. **测试环境**：建议在测试网络进行，避免使用生产数据
5. **日志监控**：观察服务器控制台日志，查看保护机制是否正确触发

---

## 测试成功标志

✅ 所有6个测试场景通过
✅ 无数据不一致问题
✅ 余额计算准确
✅ 冻结/解冻逻辑正确
✅ 审核流程完整

测试通过后，即可部署到生产环境！
