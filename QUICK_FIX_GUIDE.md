# 派对危机快速修复指南

## 问题1: 余额不足无法下注

### 原因
`game-balances.json` 中的 `balances` 对象是空的，即使前端显示有余额，后端也检测不到。

### 解决方案：添加测试余额

使用以下命令给你的钱包地址添加余额：

```bash
node add-test-balance.js <你的钱包地址> 1000
```

例如：
```bash
node add-test-balance.js 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb 1000
```

这将：
- 添加 1000 DP 到指定地址
- 如果用户不存在，自动创建用户信息
- 添加充值交易记录

### 或者手动编辑文件

打开 `data/game-balances.json`，在 `balances` 对象中添加你的地址（小写）：

```json
{
  "balances": {
    "0x你的地址(小写)": 1000
  },
  ...
}
```

---

## 问题2: 杀手动画不显示

### 已修复内容

1. **增强调试日志** - 控制台会显示：
   - 杀手阶段开始
   - 目标房间信息
   - 杀手创建过程
   - 杀手移动步骤

2. **优化动画触发** - 添加了：
   - 杀手元素样式强化（position, zIndex, fontSize）
   - 错误检查和提示
   - Toast 消息提示目标房间

3. **修复killPlayers函数** - 现在只会将被刺杀房间的角色变成金币

### 测试步骤

1. 启动后端服务器：
   ```bash
   npm start
   ```

2. 添加测试余额（使用你的实际钱包地址）：
   ```bash
   node add-test-balance.js 0x你的钱包地址 1000
   ```

3. 打开前端页面 `game-platform.html`

4. 打开浏览器控制台（F12）

5. 连接钱包

6. 选择房间并下注（1-500 DP）

7. 等待倒计时结束，观察：
   - 控制台日志显示 `[派对危机] 杀手阶段开始!`
   - 控制台日志显示 `[杀手动画] 开始创建杀手`
   - 地图上出现 💀 杀手角色
   - 杀手沿路径移动到目标房间
   - 到达后，目标房间的角色变成 💰 金币
   - 杀手原路返回并消失

8. 查看结算信息：
   - 如果幸存：显示 "🎉 恭喜！你幸存了！获得奖励 XX DP"
   - 如果被杀：显示 "💀 很遗憾，你被杀手消灭了..."

---

## 预期行为

### 投注阶段（60秒）
- 可以选择房间
- 可以下注 1-500 DP
- 可以追加投注（同一房间）
- 不能切换房间（已下注后）

### 杀手阶段（14秒）
- 显示 "🚨 杀手出现！目标：XX"
- 杀手从入口出现
- 沿路径移动到目标房间（9秒）
- 到达后刺杀房间内所有玩家（1秒）
- 原路返回入口（4秒）

### 结算阶段
- 显示 "结算中..."
- 幸存玩家按投注权重瓜分奖池
- 自动扣除10%平台费
- 刷新余额

### 新游戏开始
- 自动清理UI
- 重新加载余额
- 重新加载历史记录
- 开始新的60秒倒计时

---

## 常见问题

### Q: 余额显示224.05 DP但提示余额不足？
A: 前端余额和后端余额是两个独立系统。使用 `add-test-balance.js` 添加后端余额。

### Q: 杀手动画没有出现？
A: 检查浏览器控制台日志。应该能看到 `[杀手动画] 开始创建杀手`。如果没有，说明后端没有进入杀手阶段。

### Q: 所有角色都变成金币了？
A: 已修复。现在只有被刺杀房间的角色会变成金币。

### Q: 没有看到结算提示？
A: 确保你参与了本局游戏（已下注）。结算提示会在结算阶段显示。

---

## 调试技巧

1. **查看后端日志**
   - 启动服务器后会显示游戏状态
   - 每局游戏的杀手目标
   - 玩家下注信息

2. **查看前端控制台**
   - `[派对危机]` 开头的是游戏状态同步日志
   - `[杀手动画]` 开头的是杀手动画日志
   - 任何错误都会在这里显示

3. **检查余额文件**
   ```bash
   cat data/game-balances.json
   ```
   确认你的地址在 `balances` 对象中

---

## 完整测试流程示例

```bash
# 1. 添加余额
node add-test-balance.js 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb 1000

# 2. 启动服务器
npm start

# 3. 打开浏览器，访问 game-platform.html
# 4. F12 打开控制台
# 5. 连接钱包
# 6. 选择房间 1-8
# 7. 输入下注金额 10-500
# 8. 点击"下注"
# 9. 观察倒计时和杀手动画
# 10. 查看结算结果
```

预期在控制台看到：
```
✅ 成功添加余额:
   地址: 0x742d35cc6634c0532925a3b844bc9e7595f0beb
   余额: 1000 DP
   
[派对危机] 同步游戏状态...
[派对危机] 玩家下注成功
[派对危机] 杀手阶段开始! { targetRoom: 3, roomName: '休息区' }
[杀手动画] 开始创建杀手，目标房间: 3
[杀手动画] 杀手已创建，初始位置: { x: 7.5, y: 50.5 }
[杀手动画] 刺杀房间 3: 休息区
[杀手动画] 房间内玩家数: 4
```
